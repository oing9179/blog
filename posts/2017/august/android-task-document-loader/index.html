<!DOCTYPE html>
<html lang="zh">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://oing9179.github.io/blog/images/favicon.png" />
<title>[Android] Task &amp; Document / Loader | Hotaru&#39;s Notebook</title>
<meta name="title" content="[Android] Task &amp; Document / Loader" />
<meta name="description" content="Preface 这个月状态挺差的，各种不顺心和意外，不过还是照例把新学的东西整理一下吧。
Task 和 Document 的基本概念 Loader 的基本概念和用法 Task &amp; Document Task 下面的代码将启动照相机:
Intent lIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); startActivityForResult(lIntent); 效果如图:
想把照相机和自己的 App 分开的话，就这样:
Intent lIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); lIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); startActivityForResult(lIntent); 效果如图:
这张图里看上去有两个 App，在 Android 官方文档 里给每个像上图里的 App 定义了一个术语叫做 &ldquo;Task&rdquo;，也就是上图里有2个 Task。容纳许多个 Task 的整个屏幕（也就是上图里的整个屏幕）就叫做 &ldquo;Recents screen&rdquo;（其他非正式名称包括但不限于: Overview screen, Recent apps）.
Document 使用下面的代码可以让自己的 App 的某个 Activity 以多个 Task 的形式展现在 Recents screen 里:
Intent lIntent = new Intent(this, NewActivity.class); lIntent.addFlags(Intent.FLAG_ACTIVITY_MULTIPLE_TASK); lIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_DOCUMENT); startActivity(lIntent); // 在新的 Activity 里使用下面的代码可以修改 Recents screen 里每个 Task 的标题 setTaskDescription(new ActivityManager." />
<meta name="keywords" content="Android,Task,Document,Loader," />


<meta property="og:title" content="[Android] Task &amp; Document / Loader" />
<meta property="og:description" content="Preface 这个月状态挺差的，各种不顺心和意外，不过还是照例把新学的东西整理一下吧。
Task 和 Document 的基本概念 Loader 的基本概念和用法 Task &amp; Document Task 下面的代码将启动照相机:
Intent lIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); startActivityForResult(lIntent); 效果如图:
想把照相机和自己的 App 分开的话，就这样:
Intent lIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); lIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); startActivityForResult(lIntent); 效果如图:
这张图里看上去有两个 App，在 Android 官方文档 里给每个像上图里的 App 定义了一个术语叫做 &ldquo;Task&rdquo;，也就是上图里有2个 Task。容纳许多个 Task 的整个屏幕（也就是上图里的整个屏幕）就叫做 &ldquo;Recents screen&rdquo;（其他非正式名称包括但不限于: Overview screen, Recent apps）.
Document 使用下面的代码可以让自己的 App 的某个 Activity 以多个 Task 的形式展现在 Recents screen 里:
Intent lIntent = new Intent(this, NewActivity.class); lIntent.addFlags(Intent.FLAG_ACTIVITY_MULTIPLE_TASK); lIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_DOCUMENT); startActivity(lIntent); // 在新的 Activity 里使用下面的代码可以修改 Recents screen 里每个 Task 的标题 setTaskDescription(new ActivityManager." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://oing9179.github.io/blog/posts/2017/august/android-task-document-loader/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2017-08-11T21:33:00+00:00" />
<meta property="article:modified_time" content="2017-08-11T21:33:00+00:00" /><meta property="og:site_name" content="Hotaru&#39;s Notebook" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[Android] Task &amp; Document / Loader"/>
<meta name="twitter:description" content="Preface 这个月状态挺差的，各种不顺心和意外，不过还是照例把新学的东西整理一下吧。
Task 和 Document 的基本概念 Loader 的基本概念和用法 Task &amp; Document Task 下面的代码将启动照相机:
Intent lIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); startActivityForResult(lIntent); 效果如图:
想把照相机和自己的 App 分开的话，就这样:
Intent lIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); lIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); startActivityForResult(lIntent); 效果如图:
这张图里看上去有两个 App，在 Android 官方文档 里给每个像上图里的 App 定义了一个术语叫做 &ldquo;Task&rdquo;，也就是上图里有2个 Task。容纳许多个 Task 的整个屏幕（也就是上图里的整个屏幕）就叫做 &ldquo;Recents screen&rdquo;（其他非正式名称包括但不限于: Overview screen, Recent apps）.
Document 使用下面的代码可以让自己的 App 的某个 Activity 以多个 Task 的形式展现在 Recents screen 里:
Intent lIntent = new Intent(this, NewActivity.class); lIntent.addFlags(Intent.FLAG_ACTIVITY_MULTIPLE_TASK); lIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_DOCUMENT); startActivity(lIntent); // 在新的 Activity 里使用下面的代码可以修改 Recents screen 里每个 Task 的标题 setTaskDescription(new ActivityManager."/>



<meta itemprop="name" content="[Android] Task &amp; Document / Loader">
<meta itemprop="description" content="Preface 这个月状态挺差的，各种不顺心和意外，不过还是照例把新学的东西整理一下吧。
Task 和 Document 的基本概念 Loader 的基本概念和用法 Task &amp; Document Task 下面的代码将启动照相机:
Intent lIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); startActivityForResult(lIntent); 效果如图:
想把照相机和自己的 App 分开的话，就这样:
Intent lIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE); lIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); startActivityForResult(lIntent); 效果如图:
这张图里看上去有两个 App，在 Android 官方文档 里给每个像上图里的 App 定义了一个术语叫做 &ldquo;Task&rdquo;，也就是上图里有2个 Task。容纳许多个 Task 的整个屏幕（也就是上图里的整个屏幕）就叫做 &ldquo;Recents screen&rdquo;（其他非正式名称包括但不限于: Overview screen, Recent apps）.
Document 使用下面的代码可以让自己的 App 的某个 Activity 以多个 Task 的形式展现在 Recents screen 里:
Intent lIntent = new Intent(this, NewActivity.class); lIntent.addFlags(Intent.FLAG_ACTIVITY_MULTIPLE_TASK); lIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_DOCUMENT); startActivity(lIntent); // 在新的 Activity 里使用下面的代码可以修改 Recents screen 里每个 Task 的标题 setTaskDescription(new ActivityManager."><meta itemprop="datePublished" content="2017-08-11T21:33:00+00:00" />
<meta itemprop="dateModified" content="2017-08-11T21:33:00+00:00" />
<meta itemprop="wordCount" content="522">
<meta itemprop="keywords" content="Android,Task,Document,Loader," />
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  body {
    font-family: Verdana, sans-serif;
    margin: auto;
    padding: 20px;
    max-width: 720px;
    text-align: left;
    background-color: #fff;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: #444;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  strong,
  b {
    color: #222;
  }

  a {
    color: #3273dc;
     
  }

  .title {
    text-decoration: none;
    border: 0;
  }

  .title span {
    font-weight: 400;
  }

  nav a {
    margin-right: 10px;
  }

  textarea {
    width: 100%;
    font-size: 16px;
  }

  input {
    font-size: 16px;
  }

  content {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  img {
    max-width: 100%;
  }

  code {
    padding: 2px 5px;
    background-color: #f2f2f2;
  }

  pre code {
    color: #222;
    display: block;
    padding: 20px;
    white-space: pre-wrap;
    font-size: 14px;
  }

  div.highlight pre {
    background-color: initial;
    color: initial;
  }

  div.highlight code {
    background-color: unset;
    color: unset;
  }

  blockquote {
    border-left: 1px solid #999;
    color: #222;
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px;
    text-align: center;
  }

  .helptext {
    color: #777;
    font-size: small;
  }

  .errorlist {
    color: #eba613;
    font-size: small;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: #8b6fcb;
  }

  @media (prefers-color-scheme: dark) {
    body {
      background-color: #333;
      color: #ddd;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    strong,
    b {
      color: #eee;
    }

    a {
      color: #8cc2dd;
    }

    code {
      background-color: #777;
    }

    pre code {
      color: #ddd;
    }

    blockquote {
      color: #ccc;
    }

    textarea,
    input {
      background-color: #252525;
      color: #ddd;
    }

    .helptext {
      color: #aaa;
    }
  }

</style>

</head>

<body>
  <header><a href="https://oing9179.github.io/blog/" class="title">
  <h2>Hotaru&#39;s Notebook</h2>
</a>
<nav><a href="https://oing9179.github.io/blog/">Home</a>

<a href="https://oing9179.github.io/blog/cv-resume/">CV / Résumé</a>


<a href="https://oing9179.github.io/blog/blog">Blog</a>

</nav>
</header>
  <main>

<h1>[Android] Task &amp; Document / Loader</h1>
<p>
  <i>
    <time datetime='2017-08-11' pubdate>
      11 Aug, 2017
    </time>
  </i>
</p>

<content>
  <h1 id="preface">Preface</h1>
<p>这个月状态挺差的，各种不顺心和意外，不过还是照例把新学的东西整理一下吧。</p>
<ul>
<li>Task 和 Document 的基本概念</li>
<li>Loader 的基本概念和用法</li>
</ul>
<!-- more -->
<h1 id="task--document">Task &amp; Document</h1>
<h2 id="task">Task</h2>
<p>下面的代码将启动照相机:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Intent lIntent <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">(</span>MediaStore<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_IMAGE_CAPTURE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>startActivityForResult<span style="color:#f92672">(</span>lIntent<span style="color:#f92672">);</span>
</span></span></code></pre></div><p>效果如图:</p>
<p><img src="https://oing9179.github.io/blog/static/images/blog/201708-Android-Task-Document-Loader/camera_activity_in_same_task.png" alt="Camera Activity in same Task" title="Camera Activity in same Task"></p>
<p>想把照相机和自己的 App 分开的话，就这样:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Intent lIntent <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">(</span>MediaStore<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTION_IMAGE_CAPTURE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>lIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">addFlags</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ACTIVITY_NEW_TASK</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>startActivityForResult<span style="color:#f92672">(</span>lIntent<span style="color:#f92672">);</span>
</span></span></code></pre></div><p>效果如图:</p>
<p><img src="https://oing9179.github.io/blog/static/images/blog/201708-Android-Task-Document-Loader/camera_activity_in_different_task.png" alt="Camera Activity in different task" title="Camera Activity in different task"></p>
<p>这张图里看上去有两个 App，在 <a href="https://developer.android.com/guide/components/activities/tasks-and-back-stack.html">Android 官方文档</a> 里给每个像上图里的 App 定义了一个术语叫做 &ldquo;Task&rdquo;，也就是上图里有2个 Task。容纳许多个 Task 的整个屏幕（也就是上图里的整个屏幕）就叫做 &ldquo;Recents screen&rdquo;（其他非正式名称包括但不限于: Overview screen, Recent apps）.</p>
<h2 id="document">Document</h2>
<p>使用下面的代码可以让自己的 App 的某个 Activity 以多个 Task 的形式展现在 Recents screen 里:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Intent lIntent <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Intent<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> NewActivity<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>lIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">addFlags</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ACTIVITY_MULTIPLE_TASK</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>lIntent<span style="color:#f92672">.</span><span style="color:#a6e22e">addFlags</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">FLAG_ACTIVITY_NEW_DOCUMENT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>startActivity<span style="color:#f92672">(</span>lIntent<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在新的 Activity 里使用下面的代码可以修改 Recents screen 里每个 Task 的标题
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>setTaskDescription<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">TaskDescription</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;The title&#34;</span><span style="color:#f92672">));</span>
</span></span></code></pre></div><p><img src="https://oing9179.github.io/blog/static/images/blog/201708-Android-Task-Document-Loader/multiple_documents.png" alt="Multiple documents" title="Multiple documents"></p>
<p>Task 是相对于 Recents screen 而言的，也就是上面的图片里一共有 <strong>3</strong> 个 Task。<a href="https://developer.android.com/guide/components/activities/recents.html">Android 官方文档</a> 创造了一个新的概念称之为 &ldquo;Document&rdquo;，Document 是相对于单个 App 而言的，以上面的图片为例的话，<code>Hello Android</code> 这个 App 就有 <strong>2</strong> 个 Document，照相机 App 只有1个 Document。
不过我觉得还有另一种说法, 上面的 Hello Android 创建了一个新的 Task 名为 <code>The title -4771557</code>, 这个新的 Task 才算做是 Document, 原来已经存在的叫做 <code>Hello Android</code> 的 Task 不能称之为 Document, 因此 Hello Android 这个 App 一共有<strong>1</strong>个 Document。
至于哪种说法是对的 我也没能在官方文档中找到。</p>
<h1 id="loader">Loader</h1>
<p>以我目前的经验来看，Loader 适合那种设计上耗时不太长的操作（1s 或更少，比如使用 ContentProvider 请求数据，或者是 从设备存储里读取某个文件，并且不指望这个异步操作能完成），其最终目的是让 App 尽快响应用户的操作（Responsive）。目前来看，相比 <code>AsyncTask</code>，<code>LoaderManager</code> 会帮我 handle 一些 Activity/Fragment 的生命周期事件，并在适当的时候通知我分配/回收资源。在配置发生变动时（比如屏幕旋转）会导致 Activity/Fragment 被重新创建，这种情况下用 LoaderManager 就比手动管理 AsyncTask 来得省事。</p>
<h2 id="实现-asynctaskloader">实现 <code>AsyncTaskLoader</code></h2>
<p>鉴于我还没有学到 ContentProvider 那一章，所以目前先用 <code>AsyncTaskLoader</code> 来做演示。</p>
<ol>
<li>新建一个类并继承 <code>android.content.AsyncTaskLoader</code></li>
<li>Override 下列方法
<ul>
<li><code>onStartLoading()</code></li>
<li><code>loadInBackground()</code></li>
<li><code>onStopLoading()</code></li>
<li><code>deliverResult(D data)</code></li>
<li><code>onReset()</code></li>
</ul>
</li>
</ol>
<p>下面展示一个 <code>AsyncTaskLoader</code> 的一种实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LoaderImpl</span> <span style="color:#66d9ef">extends</span> AsyncTaskLoader<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> LOADER_ID <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String mStrUrl<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String mData<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">LoaderImpl</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> Bundle parameters<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        mStrUrl <span style="color:#f92672">=</span> parameters<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;url&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onStartLoading</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Loader 被初始化后会立即自动调用这个方法.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 如果这个 Loader 在 Activity/Fragment 被重建之前曾经载入过数据(也就是 loadInBackgroun())
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 被调用过, 这里就可以直接把之前载入过的数据直接返回.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 载入过的数据需要在 deliverResult(D data) 里进行缓存.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 如果有其他的需要在载入数据之前做的事情, 也需要在这里做, 等同于 AsyncTask.onPreExecute().
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mData <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果有缓存的数据 则直接返回.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            deliverResult<span style="color:#f92672">(</span>mData<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果缓存是空的 则载入新的数据.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            forceLoad<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 调用 forceLoad() 后 loadInBackground() 就会被调用.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">loadInBackground</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* 等同于 AsyncTask.doInBackground(Object... params). */</span>
</span></span><span style="display:flex;"><span>        String lStrResult <span style="color:#f92672">=</span> downloadHtmlFromSomewhere<span style="color:#f92672">(</span>mStrUrl<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> lStrResult<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onStopLoading</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* 这个 onStopLoading() 的设计实在是无法理解, 稍后再具体解释. */</span>
</span></span><span style="display:flex;"><span>        cancelLoad<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deliverResult</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>PackageInfo<span style="color:#f92672">&gt;</span> data<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 可以在这里缓存 loadInBackground() 的结果, 然后再交由父类将结果递交出去.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        mData <span style="color:#f92672">=</span> data<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">deliverResult</span><span style="color:#f92672">(</span>data<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onReset</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 在这里释放当前 Loader 使用的所有资源.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onReset</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        onStopLoading<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mFilterAndSortOption</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="实现-loadermanagerloadercallbacks">实现 <code>LoaderManager.LoaderCallbacks</code></h2>
<p>该接口的实现负责处理下面这几件事:</p>
<ol>
<li><code>onCreateLoader(int id, Bundle args)</code>: 负责根据 ID 为 LoaderManager 提供相应的 Loader 实例</li>
<li><code>onLoadFinished(Loader loader, D data)</code>: Loader 运行出结果后会把结果递送到这里, <code>data</code> 就是结果</li>
<li><code>onLoaderReset(Loader loader)</code>: 当 Loader 需要被回收的时候调用该回调函数</li>
</ol>
<p>下面是一个 <code>LoaderManager.LoaderCallbacks</code> 的实现的例子:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LoaderCallbacksImpl</span> <span style="color:#66d9ef">implements</span> LoaderManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LoaderCallbacks</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Loader <span style="color:#a6e22e">onCreateLoader</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">,</span> Bundle args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>args <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> args <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Bundle<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>id <span style="color:#f92672">==</span> LoaderImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">LOADER_ID</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> LoaderPackageList<span style="color:#f92672">(</span>getContext<span style="color:#f92672">(),</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LoaderId not found: &#34;</span> <span style="color:#f92672">+</span> id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onLoadFinished</span><span style="color:#f92672">(</span>Loader loader<span style="color:#f92672">,</span> Object data<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loader<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> LoaderImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">LOADER_ID</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            processResult<span style="color:#f92672">((</span>String<span style="color:#f92672">)</span> data<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onLoaderReset</span><span style="color:#f92672">(</span>Loader loader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>loader<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> LoaderPackageList<span style="color:#f92672">.</span><span style="color:#a6e22e">LOADER_ID</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            releaseResources<span style="color:#f92672">(</span>loader<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="asynctaskloader-的优缺点"><code>AsyncTaskLoader</code> 的优缺点</h2>
<p>优点:</p>
<ol>
<li>LoaderManager 会在 Activity/Fragment 发生配置变化的时候 管理好它所管理的 Loader 实例</li>
</ol>
<p>缺点:</p>
<ol>
<li><code>AsyncTaskLoader</code> 没有 <code>AsyncTask</code> 的 <code>publishProgress()</code>, 想在界面上展示进度的话 还得另想办法.
因为 Loader 的性质导致它不能强引用某个 Activity/Fragment, 所以还得考虑用 WeakReference 或者 Handler 来实现.</li>
<li>想中断正在运行的 Loader 需要调用 <code>cancelLoad()</code>, 但 <code>cancelLoad()</code> 运行在主线程而不是 <code>loadInBackground()</code> 所在的 Worker Thread, 因此没法使用标准的 Thread API <code>Thread.currentThread().interrupt()</code> 和 <code>Thread.currentThread().isInterrupted()</code> 来中断正在运行的 Loader. 由此带来的问题就是: 如果 <code>loadInBackground()</code> 里的代码想知道当前 Loader 是否想中断运行的话, 还得使用 <code>Loader.isLoadInBackgroundCancelled()</code> 来判断, 这样就将所有代码限制到只能在 <code>loadInBackground()</code>, 不能分开到其它的类里.</li>
</ol>
<p>综合上面的2个缺点, 我认为 AsyncTaskLoader 不适合用来做过长时间的、需要用户感知到进度的操作。也许以后得自己实现一个类似 AsyncTaskLoader 的类来弥补上面的缺点。</p>
<h1 id="结语">结语</h1>
<p>可以说 这篇博文写得非常不走心，Android 官方文档有些晦涩不清，搞得我光是 Task/Document 的概念就查了好多资料才理解它。后来又看 Loader，它的优点在缺点的掩盖下分文不值。</p>
<h1 id="references">References</h1>
<ol>
<li><a href="https://developer.android.com/guide/components/activities/tasks-and-back-stack.html">Tasks and Back Stack | Android Developers - developer.android.com</a></li>
<li><a href="https://developer.android.com/guide/components/activities/recents.html">Recents Screen | Android Developers - developer.android.com</a></li>
<li><a href="https://medium.com/google-developers/dominating-the-overview-screen-eef18d2195d">Dominating the Overview Screen – Google Developers – medium.com</a></li>
</ol>

</content>
<p>
  
  <a href="https://oing9179.github.io/blog/tags/android/">#Android</a>
  
  <a href="https://oing9179.github.io/blog/tags/task/">#Task</a>
  
  <a href="https://oing9179.github.io/blog/tags/document/">#Document</a>
  
  <a href="https://oing9179.github.io/blog/tags/loader/">#Loader</a>
  
</p>

  </main>
  <footer>Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>
</footer>

    
</body>

</html>
