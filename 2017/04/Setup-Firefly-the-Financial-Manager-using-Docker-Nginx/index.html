<!doctype html>




<html class="theme-next mist" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Linux,Docker,Nginx,Firefly,Finical Manager," />





  <link rel="alternate" href="/blog/rss2.xml" title="oing9179 的笔记本儿" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.1.0" />






<meta name="description" content="Preface“我辛辛苦苦挣的钱都去哪儿了”，我可不希望以后什么什么时候开始说这种话，于是 搭建个记账软件来记录自己的收支吧。该软件优点如下：

资金流向：比如钱都花在哪些类目上了，钱都流向哪些商家了。
资金预算：比如打算每个月花多少钱在饮食上。
分类 &amp;amp; 标签：比如钱都花在那些类目上了。
交易记录：除了收入和支出记录外，如有多个银行账户的话 还能记录不同账户之间的转帐交易
存钱罐（Pig">
<meta property="og:type" content="article">
<meta property="og:title" content="用 Docker & Nginx 搭建自己的账本（Firefly）">
<meta property="og:url" content="https://oing9179.github.io/blog/2017/04/Setup-Firefly-the-Financial-Manager-using-Docker-Nginx/index.html">
<meta property="og:site_name" content="oing9179 的笔记本儿">
<meta property="og:description" content="Preface“我辛辛苦苦挣的钱都去哪儿了”，我可不希望以后什么什么时候开始说这种话，于是 搭建个记账软件来记录自己的收支吧。该软件优点如下：

资金流向：比如钱都花在哪些类目上了，钱都流向哪些商家了。
资金预算：比如打算每个月花多少钱在饮食上。
分类 &amp;amp; 标签：比如钱都花在那些类目上了。
交易记录：除了收入和支出记录外，如有多个银行账户的话 还能记录不同账户之间的转帐交易
存钱罐（Pig">
<meta property="og:updated_time" content="2017-04-19T00:45:52.844Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用 Docker & Nginx 搭建自己的账本（Firefly）">
<meta name="twitter:description" content="Preface“我辛辛苦苦挣的钱都去哪儿了”，我可不希望以后什么什么时候开始说这种话，于是 搭建个记账软件来记录自己的收支吧。该软件优点如下：

资金流向：比如钱都花在哪些类目上了，钱都流向哪些商家了。
资金预算：比如打算每个月花多少钱在饮食上。
分类 &amp;amp; 标签：比如钱都花在那些类目上了。
交易记录：除了收入和支出记录外，如有多个银行账户的话 还能记录不同账户之间的转帐交易
存钱罐（Pig">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://oing9179.github.io/blog/2017/04/Setup-Firefly-the-Financial-Manager-using-Docker-Nginx/"/>





  <title> 用 Docker & Nginx 搭建自己的账本（Firefly） | oing9179 的笔记本儿 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-91332739-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">oing9179 的笔记本儿</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">This is subtitle.</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/blog/links" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br />
            
            Links
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://oing9179.github.io/blog/blog/2017/04/Setup-Firefly-the-Financial-Manager-using-Docker-Nginx/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="oing9179">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://www.gravatar.com/avatar/e1bd13468682c8192041be77e8136ea5?s=128">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oing9179 的笔记本儿">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="oing9179 的笔记本儿" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                用 Docker & Nginx 搭建自己的账本（Firefly）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-18T07:47:03+08:00">
                18 April 2017
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/blog/2017/04/Setup-Firefly-the-Financial-Manager-using-Docker-Nginx/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/04/Setup-Firefly-the-Financial-Manager-using-Docker-Nginx/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>“我辛辛苦苦挣的钱都去哪儿了”，我可不希望以后什么什么时候开始说这种话，于是 搭建个记账软件来记录自己的收支吧。<br>该软件优点如下：</p>
<ul>
<li>资金流向：比如钱都花在哪些类目上了，钱都流向哪些商家了。</li>
<li>资金预算：比如打算每个月花多少钱在饮食上。</li>
<li>分类 &amp; 标签：比如钱都花在那些类目上了。</li>
<li>交易记录：除了收入和支出记录外，如有多个银行账户的话 还能记录不同账户之间的转帐交易</li>
<li>存钱罐（Piggy Banks）：比如想买个手机但是目前没有那么多预算，可以先弄个存钱罐，然后一点一点的往里面存。相当于一个长远的资金预算。</li>
<li>账单：每月水电费之类的。</li>
<li>规则：比如填写支出描述时自动填写预设的支出金额。</li>
<li>报表（Reports）：按月、季、年生成报表，账户余额、资金流向、短期/长期预算、账单 等等。</li>
<li>多货币：软妹币, 美刀, 英镑, 比特币，想用什么就用什么（不支持货币换算，在创建收支记录时候可以手动填写换算前后的金额）。</li>
<li>数据导入导出：导入导出 <code>csv</code> 格式的文件，进一步对资金流向做分析什么的。</li>
</ul>
<p>目前我能想到的唯一缺点就是：没能和各种银行/支付机构（比如支付婊）进行接口对接，实现自动记录收入支出。<br>另外，该软件作者表示 “不支持自动支付重复性交易”，原因是：</p>
<blockquote>
<p>I believe that if you are serious about changing your financial habits, you should be aware of what happens on your accounts. The money you spend and the money you earn. By entering each transaction manually, you will <em>feel</em> what you spend.<br>我认为如果你真的想改变你的财务习惯的话，你应该更关心你的账户，你花的钱还有你挣的钱。通过手动地录入每次交易，让你<em>切实体会到</em>钱都花在哪里了。</p>
</blockquote>
<a id="more"></a>
<h1 id="安装-amp-更新-Docker-docker-ce"><a href="#安装-amp-更新-Docker-docker-ce" class="headerlink" title="安装 &amp; 更新 Docker (docker-ce)"></a>安装 &amp; 更新 Docker (<code>docker-ce</code>)</h1><p>近些天 Docker 更新了，连软件包名字也变了。<code>docker-ce</code> 对应 Docker 社区版（Community Edition），<code>docker-ee</code> 对应 Docker 企业版（Enterprise Edition）。</p>
<ol>
<li><p>如果原来安装过 Docker 的话，先卸载旧版</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get remove docker docker-engine</div></pre></td></tr></table></figure>
</li>
<li><p>通过安装下面的软件包使 <code>apt</code> 通过 HTTPS 下载 Docker 安装包</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install \</div><div class="line">    apt-transport-https \</div><div class="line">    ca-certificates \</div><div class="line">    curl \</div><div class="line">    software-properties-common</div></pre></td></tr></table></figure>
</li>
<li><p>添加 Docker 的 GPG key</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</div></pre></td></tr></table></figure>
<p> 执行命令 <code>sudo apt-key fingerprint 0EBFCD88</code> 后的输出应该大致是这样：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">pub   4096R/0EBFCD88 2017-02-22</div><div class="line">      Key fingerprint = 9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88</div><div class="line">uid                  Docker Release (CE deb) &lt;docker@docker.com&gt;</div><div class="line">sub   4096R/F273FCD8 2017-02-22</div></pre></td></tr></table></figure>
</li>
<li><p>添加 Docker 软件源</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo add-apt-repository \</div><div class="line">   &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</div><div class="line">   $(lsb_release -cs) \</div><div class="line">   stable&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>安装 Docker</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get update &amp;&amp; apt-get install docker-ce</div></pre></td></tr></table></figure>
<p> 然后等一段时间就安装好了。</p>
</li>
</ol>
<h1 id="构建和部署-Docker-Image"><a href="#构建和部署-Docker-Image" class="headerlink" title="构建和部署 Docker Image"></a>构建和部署 Docker Image</h1><ol>
<li><p>更新 <code>docker-compose</code> 到最新版，可以参考 <a href="https://github.com/docker/compose/releases" target="_blank" rel="external">这里</a> 的说明</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -L https://github.com/docker/compose/releases/download/1.12.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</div><div class="line">chmod +x /usr/local/bin/docker-compose</div></pre></td></tr></table></figure>
</li>
<li><p>从 GitHub clone Firefly 下来</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/firefly-iii/firefly-iii.git</div><div class="line">cd ./firefly-iii/</div><div class="line"># 使用 git checkout tags/&lt;版本号 tag&gt; -b &lt;新的分支名&gt; 来 checkout 指定版本的 Firefly</div><div class="line">git checkout tags/4.3.8 -b v4.3.8</div></pre></td></tr></table></figure>
</li>
<li><p>在当前目录下创建并编辑 <code>docker-compose.my.yml</code>，<code>environment</code> 里配置项的具体说明可以参考 <a href="https://firefly-iii.github.io/using-installing.html" target="_blank" rel="external">这里</a></p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  firefly-app:</span></div><div class="line"><span class="attr">    image:</span> firefly-iii</div><div class="line"><span class="attr">    build:</span> .</div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="attr">      FF_DB_HOST:</span> <span class="string">"localhost"</span> <span class="comment"># 这里暂时用 localhost，等 Firefly 部署后再进入 docker 容器查看 IP 地址</span></div><div class="line"><span class="attr">      FF_DB_NAME:</span> <span class="string">"firefly"</span> <span class="comment"># 数据库名称</span></div><div class="line"><span class="attr">      FF_DB_USER:</span> <span class="string">"firefly"</span> <span class="comment"># 数据库用户名</span></div><div class="line"><span class="attr">      FF_DB_PASSWORD:</span> <span class="string">"连接数据库的密码"</span></div><div class="line"><span class="attr">      FF_APP_KEY:</span> <span class="string">"32个随机英文和数字字符"</span></div><div class="line"><span class="attr">      FF_APP_ENV:</span> <span class="string">"production"</span></div><div class="line"><span class="attr">      SITE_OWNER:</span> <span class="string">"填写自己的邮箱"</span></div><div class="line"><span class="attr">      APP_FORCE_SSL:</span> <span class="string">"true"</span> <span class="comment"># 强制使用 HTTPS 连接</span></div><div class="line"><span class="attr">      APP_FORCE_ROOT:</span> <span class="string">"https://qian.example.com"</span> <span class="comment"># 改成自己网站的 URL, 下同</span></div><div class="line"><span class="attr">      APP_URL:</span> <span class="string">"https://qian.example.com"</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"127.0.0.1:8082:80/tcp"</span> <span class="comment"># 将 docker 容器的 80 端口映射到本机的 8082 端口上</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line">      <span class="comment"># 将 docker 容器内的 /var/www/firefly-iii/storage 映射到本机的 /somewhere/storage 目录下</span></div><div class="line">      <span class="comment"># storage 目录下将存放 Firefly 所需的文件（比如创建收支记录时候上传的附件）</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"/var/www/firefly-iii/storage:/somewhere/storage"</span></div></pre></td></tr></table></figure>
</li>
<li><p>创建 Docker 容器，这一步会花费较长的时间</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker-compose -f docker-compose.my.yml create</div></pre></td></tr></table></figure>
</li>
<li><p>对刚创建出来的 Docker 容器改名，改名前的名字大概会像下面这样，改成 <code>firefly</code> 省得后续再写命令时候写那么大一长串：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rename fireflyiii_firefly-app_1 firefly</div></pre></td></tr></table></figure>
</li>
<li><p>启动 Firefly Docker image</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker start firefly</div></pre></td></tr></table></figure>
<p> 运行 <code>curl http://127.0.0.1:8082</code>，如果看到有 HTML 输出的话就行了。</p>
</li>
<li><p>查看 Docker 容器的 IP 和 Gateway</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 进入正在运行的 Docker 容器内</div><div class="line">docker exec -i firefly /bin/bash -il</div><div class="line"># 查看 IP 和 Gateway</div><div class="line">ip route show default</div></pre></td></tr></table></figure>
<p> 输出的内容大致是这样，将 Gateway（也就是下面的 <code>127.17.0.1</code>）和 IP（也就是 <code>127.17.0.2</code>）记录下来备用：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">default via 172.17.0.1 dev eth0 # 127.17.0.1 就是 Gateway</div><div class="line">172.17.0.0/16 dev eth0  proto kernel  scope link  src 172.17.0.2 # 127.17.0.2 就是 Docker 容器的 IP</div></pre></td></tr></table></figure>
</li>
<li><p>编辑 <code>docker-compose.my.yml</code>，修改内容如下：</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 将 FF_DB_HOST 由 localhost 改为上面的 Gateway</span></div><div class="line"><span class="attr">FF_DB_HOST:</span> <span class="string">"172.17.0.1"</span></div></pre></td></tr></table></figure>
</li>
<li><p>执行下面命令来创建新的 Docker 容器</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># kill 掉正在运行的 Docker 容器</div><div class="line">docker kill firefly</div><div class="line"># 删掉容器和旧的 Docker Image</div><div class="line">docker rm firefly</div><div class="line">docker rmi firefly-iii</div><div class="line"># 创建新的 Docker 容器，这将应用前面对 docker-compose.my.yml 的修改</div><div class="line">docker-compose -f docker-compose.my.yml create</div><div class="line"># 改名</div><div class="line">docker rename fireflyiii_firefly-app_1 firefly</div><div class="line"># 启动 Docker 容器</div><div class="line">docker start firefly</div></pre></td></tr></table></figure>
</li>
<li><p>执行命令 <code>curl http://127.0.0.1:8082</code>，应该会有 HTML 输出</p>
</li>
</ol>
<p>接下来开始弄 Nginx。</p>
<h1 id="安装-amp-配置-Nginx"><a href="#安装-amp-配置-Nginx" class="headerlink" title="安装 &amp; 配置 Nginx"></a>安装 &amp; 配置 Nginx</h1><h2 id="安装-Nginx"><a href="#安装-Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get install nginx</div></pre></td></tr></table></figure>
<p>装完了就 <code>curl http://127.0.0.1</code> 看看效果。</p>
<h2 id="生成-Let’s-Encrypt-SSL-证书"><a href="#生成-Let’s-Encrypt-SSL-证书" class="headerlink" title="生成 Let’s Encrypt SSL 证书"></a>生成 Let’s Encrypt SSL 证书</h2><ol>
<li>先为自己的域名添加一个 <code>CNAME</code> 记录，本文将以 <code>qian.example.com</code> 为例。</li>
<li>在路径 <code>/var/www/</code> 下创建一个文件夹名为 <code>qian.example.com</code></li>
<li><p>创建并编辑文件 <code>/etc/nginx/sites-available/qian.example.com</code>，文件内容如下</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    listen [::]:80;</div><div class="line">    server_name qian.example.com;</div><div class="line">    root /var/www/qian.example.com;</div><div class="line">    location / &#123;</div><div class="line">        try_files $uri $uri/ =404;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>重启 Nginx <code>systemctl restart nginx</code></p>
</li>
<li>生成 SSL 证书 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">letsencrypt certonly --webroot -w /var/www/qian.example.com --domain &quot;qian.example.com&quot;</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="配置-Nginx-使用-SSL"><a href="#配置-Nginx-使用-SSL" class="headerlink" title="配置 Nginx 使用 SSL"></a>配置 Nginx 使用 SSL</h2><p>编辑文件 <code>/etc/nginx/sites-available/qian.example.com</code>，文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    server_name qian.example.com;</div><div class="line"></div><div class="line">    listen 443 default_server;</div><div class="line">    listen [::]:443 default_server;</div><div class="line">    access_log /var/log/nginx/$&#123;server_name&#125;_access.log;</div><div class="line"></div><div class="line">    # SSL 证书的配置，把 qian.example.com 改成自己的就好了</div><div class="line">    ssl on; </div><div class="line">    ssl_certificate /etc/letsencrypt/live/qian.example.com/fullchain.pem;</div><div class="line">    ssl_certificate_key /etc/letsencrypt/live/qian.example.com/privkey.pem;</div><div class="line"></div><div class="line">    index index.html index.php;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        proxy_redirect off;</div><div class="line">        # proxy_pass：将 HTTP 请求转发到指定端口</div><div class="line">        proxy_pass http://127.0.0.1:8082;</div><div class="line">        proxy_set_header Host $http_host;</div><div class="line">        add_header Strict-Transport-Security &quot;max-age=15552000; includeSubDomains; preload&quot; always;</div><div class="line">        client_max_body_size 16M;</div><div class="line">    &#125;</div><div class="line">    location = /.htaccess &#123;</div><div class="line">        return 403;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重启 Nginx <code>systemctl restart nginx</code>，然后执行 <code>curl https://qian.example.com</code>，输出的 HTML 应该和刚启动完 Firefly 时的输出是一样的。</p>
<h1 id="初始化-Firefly"><a href="#初始化-Firefly" class="headerlink" title="初始化 Firefly"></a>初始化 Firefly</h1><h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><ol>
<li><p>在 MariaDB 里为 Firefly 创建 <code>firefly</code> 数据库</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-- 创建 firefly 数据库</div><div class="line">CREATE DATABASE firefly CHARACTER SET = utf8 COLLATE = utf8_general_ci;</div><div class="line">-- 创建 firefly 用户</div><div class="line">CREATE USER firefly IDENTIFIED BY &apos;Passw0rd&apos;;</div><div class="line">-- 让用户 firefly 拥有 firefly 数据库的完整权限</div><div class="line">GRANT ALL ON firefly.* TO firefly;</div><div class="line">flush privileges;</div></pre></td></tr></table></figure>
</li>
<li><p>执行下面的命令创建数据库表</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 进入正在运行的 firefly Docker 容器</div><div class="line">docker exec -i firefly /bin/bash -il</div><div class="line"># 如果当前目录不是 /var/www/firefly-iii/ 下面的话则 cd 过去</div><div class="line">cd /var/www/firefly-iii/</div><div class="line"># 执行命令来初始化数据库表</div><div class="line">php artisan migrate:refresh --seed --force</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="注册并登录"><a href="#注册并登录" class="headerlink" title="注册并登录"></a>注册并登录</h2><p>打开浏览器访问 <code>https://qian.example.com</code>，注册一个帐号即可。注册完成后 注册功能会自动关闭，默认情况下只允许单个用户使用这个网站，如果想多人使用的话 可以在设置里取消勾选 “Single user mode”。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>有了之前搭建 Nextcloud 的经验，这次搭建起来省了不少时间。</p>
<h1 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h1><p>18 Apr 2017: 首次发布<br>19 Apr 2017:</p>
<ul>
<li>在 “构建和部署 Docker Image” 中增加 <code>curl</code> 命令来验证 Docker 容器是否启动</li>
<li>小修小改</li>
</ul>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ol>
<li><a href="https://docs.docker.com/engine/installation/linux/ubuntu/" target="_blank" rel="external">Get Docker for Ubuntu - docs.docker.com</a></li>
<li><a href="https://github.com/docker/compose/releases" target="_blank" rel="external">Releases · docker/compose - github.com</a></li>
<li><a href="https://firefly-iii.github.io/using-docker.html" target="_blank" rel="external">Docker - Firefly III</a></li>
<li><a href="https://firefly-iii.github.io/using-installing.html" target="_blank" rel="external">Installation guide - Firefly III</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/Linux/" rel="tag"># Linux</a>
          
            <a href="/blog/tags/Docker/" rel="tag"># Docker</a>
          
            <a href="/blog/tags/Nginx/" rel="tag"># Nginx</a>
          
            <a href="/blog/tags/Firefly/" rel="tag"># Firefly</a>
          
            <a href="/blog/tags/Finical-Manager/" rel="tag"># Finical Manager</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2017/04/Java-Concurrency-Multi-Threading-Introduction/" rel="next" title="Java 并发 & 多线程 - 基础知识">
                <i class="fa fa-chevron-left"></i> Java 并发 & 多线程 - 基础知识
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2017/04/The-Magic-SysRq-Key/" rel="prev" title="SysRq 键 - Linux 系统崩掉前最后的救命稻草">
                SysRq 键 - Linux 系统崩掉前最后的救命稻草 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://www.gravatar.com/avatar/e1bd13468682c8192041be77e8136ea5?s=128"
               alt="oing9179" />
          <p class="site-author-name" itemprop="name">oing9179</p>
          <p class="site-description motion-element" itemprop="description">Develop with pleasure!</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/blog/archives">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/blog/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/blog/tags">
                <span class="site-state-item-count">59</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/blog/rss2.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/oing9179" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/oing9179" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/blog/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Preface"><span class="nav-number">1.</span> <span class="nav-text">Preface</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装-amp-更新-Docker-docker-ce"><span class="nav-number">2.</span> <span class="nav-text">安装 & 更新 Docker (docker-ce)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#构建和部署-Docker-Image"><span class="nav-number">3.</span> <span class="nav-text">构建和部署 Docker Image</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装-amp-配置-Nginx"><span class="nav-number">4.</span> <span class="nav-text">安装 & 配置 Nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-Nginx"><span class="nav-number">4.1.</span> <span class="nav-text">安装 Nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生成-Let’s-Encrypt-SSL-证书"><span class="nav-number">4.2.</span> <span class="nav-text">生成 Let’s Encrypt SSL 证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-Nginx-使用-SSL"><span class="nav-number">4.3.</span> <span class="nav-text">配置 Nginx 使用 SSL</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#初始化-Firefly"><span class="nav-number">5.</span> <span class="nav-text">初始化 Firefly</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#初始化数据库"><span class="nav-number">5.1.</span> <span class="nav-text">初始化数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册并登录"><span class="nav-number">5.2.</span> <span class="nav-text">注册并登录</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#更新历史"><span class="nav-number">7.</span> <span class="nav-text">更新历史</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">8.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">oing9179</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'oing9179-blog';
      var disqus_identifier = '2017/04/Setup-Firefly-the-Financial-Manager-using-Docker-Nginx/';

      var disqus_title = "用 Docker & Nginx 搭建自己的账本（Firefly）";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  









  
  

  

  

  

  


</body>
</html>
